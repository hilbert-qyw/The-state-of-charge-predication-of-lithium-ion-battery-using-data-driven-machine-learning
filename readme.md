## The state-of-charge predication of lithium-ion battery  using data-driven machine learning

Author: Yuwen Qin, Xin Chen

## Background
(1) At present, the majority of energy storage systems used in power grid is specially designed batteries, particularly lithium-ion batteries. Due to the strong combustion and explosion conditions inside the batteries, many safety incidents of the battery energy storage system occur all around the world, the majority of which are caused by abnormal conditions such as battery over-charge and over-discharge, aging, and consistency attenuation, with the eventual thermal runaway<sup>[1-2]</sup>.

(2) State-of-charge (SOC) as one of the key parameters for battery management, the estimation deviation of SOC would directly influence the performance and safety of the battery energy storage system. However, due to the complicated dynamic coupling activities and mechanisms inside the battery, the SOC of the battery cannot be measured directly. Therefore, starting from the observables within the system, such as voltage, current, and temperature, is crucial for accurate calculation of battery SOC and safe and stable operation of energy storage system<sup>[3-5]</sup>.

(3) In this study, we used the CNN-LSTM neural network to estimate the SOC of lithium-ion batteries for a typical photovoltaic energy storage system. Using the system observables as input for the CNN-LSTM neural network and the SOC as output, the optimal model structure for SOC estimation is figured out. The performance of the proposed estimation method is evaluated by using the actual operation data of the energy storage system. The robustness of the model under different charging and discharging powers is investigated, and the validation results are satisfactory.



## Data

The data is from a photovoltaic-energy storage system. 

A set of 50kWp photovoltaic system combined with 108 465Wp monocrystallinesilicon cell modules totaling 49.68kWp, and a set of 200 kW/200 kWh energy storagesystem with 280Ah/3.2V LFP batteries are taken as testing platform. The integrationtechnique of the whole energy storage system can be described as follows. Firstly, abattery pack is designed with 14 battery cells linked in series, and then 16 batterypack are connected in series to produce a 200kWh energy storage system. The operation strategy of the system is as follows. Starting from 10 a.m. everyday, the photovoltaic system is turned on to charge the battery energy storage units. After the batteries are fully charged, the electricity generated by the photovoltaic systemis directly shifted to provide supply power to the load and does not connected tothepower grid. After 6:00 p.m., the energy storage system starts to discharge to the downstream load. When the stored energy is fully discharged, the load wouldbesupported with the power from the main grid, waiting for the recharging starting at 10:00 a.m. the next day. We set the top and lower limits of the SOC of the energy storage system to 90% and 10.8%, respectively, to avoid overcharging and discharging the battery and to ensure the safe and stable functioning of the whole system. Figure 1 shows the devices used in the testing platform. The operation of the energy storage system is controlled by the power conversion system, while the charging and discharging of the photovoltaic system is controlled by the inverter. All operation data of the system are first uploaded to the on-site industrial computer, and then transmitted to the server through the cloud.

![image-20230213172659733](C:\Users\11855\AppData\Roaming\Typora\typora-user-images\image-20230213172659733.png)

<center>Fig. 1 . Experimental setups of the testing system<center>

### Model implementation process

The Li-ion battery SOC prediction framework is shown in Figure 2. Firstly, the preprocessed historical flow data, including the average voltage of energy storage system, the average voltage of the battery cells, the current, the average temperature of the battery cells, and the output power of the photovoltaic system. Those preprocessed historical flow data are taken as 5 dimensions of input signals into the model. The CNN layer can rapidly extract the spatial features of the sensor flow data and then feed the processed data into the LSTM layer, which uses its features to recover the time series characteristics concealed in the spatial feature sequence. Nonlinear transformations on sensor flow data can be performed throughout the process to identify logical links between input and output. Finally, the fully connected layer exports the projected value of the SOC to accomplish an accurate assessment of the battery status.

The prediction system is split into two parts, i.e., the cloud server and the edge terminal. After the model is trained on the cloud server, the model parameters obtained online are delivered to the edge terminal device. The entire concept is a closed-loop system that allows for online learning. When the sensor flow data is monitored by the edge, it is regularly updated to the cloud server. The cloud server accepts the edge data and stores it in the corresponding database, and periodically updates the CNN-LSTM neural network parameters in the cloud server. The updated neural network model parameters would be transmitted to the edge to accurately fit the latest battery state and avoid the impact of battery capacity decline on battery SOC prediction.

<img src="C:\Users\11855\AppData\Roaming\Typora\typora-user-images\image-20230213191414621.png" alt="image-20230213191414621" style="zoom:67%;" />

<center>Fig. 2 . Principal flow chart of CNN-LSTM model<center>

#### Results

The performance of CNN-LTSM model used in this research is compared with several other sophisticated neural network models. The data from February 28 was chosen as the test set. Figure 3 shows that in the late portion of the stationary phase when the battery is drained, there is a clear spike in CNN-GRU, as well as clear variations in GRU and LSTM. CNN-GRU and LSTM varied significantly in the succeeding discharging stage before fitting to the real SOC value. The CNN-LSTM model used in this paper and GRU model both produced good prediction results, with the former having lower volatility. It can be seen from Figure 12 that the maximum error of the CNN-LSTM model proposed in this paper is only 4.18%, whereas the maximum errors of CNN&GRU, GRU and LSTM are 13.63%, 4.75%, 12.31%, respectively. The MAE, RMSE and R2 of the four models are listed in Table 1.

![image-20230213173658445](C:\Users\11855\AppData\Roaming\Typora\typora-user-images\image-20230213173658445.png)

<center>Fig. 3 . Comparison of prediction curves for models with different LSTMlayers<center>

<center>Table. 1 . Comparison of evaluation indicators of different neural network models<center>

|  Model   | RMSE  |  MAE  |   R2   |
| :------: | :---: | :---: | :----: |
| CNN-LSTM | 0.31% | 0.18% | 0.9999 |
| CNN-GRU  | 1.58% | 0.59% | 0.9983 |
|   GRU    | 0.60% | 0.37% | 0.9998 |
|   LSTM   | 3.12% | 1.42% | 0.9936 |



## Requirements

```
numpy~=1.19.2
pandas~=1.4.0
matplotlib~=3.3.2
torch~=1.9.0
scikit-learn~=0.23.2
tqdm~=4.50.2
scipy~=1.5.2
xlrd~=1.2.0
openpyxl~=3.0.5
```

Dependencies can be installed using the following command:

```python
pip install -r requirements.txt
```

### Usage

```python
python soc_model_training
```



## Reference

<div id="refer-anchor-1"></div>

- [1] FENG X, OUYANG M, LIU X, et al. Thermal runaway mechanism of lithium ion battery for electric vehicles: A review [J]. Energy Storage Materials, 2018, 10: 246-67. https://doi.org/10.1016/j.ensm.2017.05.013

<div id="refer-anchor-2"></div>

- [2] FAN X, LIU B, LIU J, et al. Battery Technologies for Grid-Level Large-Scale Electrical EnergyStorage [J]. Transactions of Tianjin University, 2020, 26(2): 92-103. https://doi.org/10.1007/s12209-019-00231-w

<div id="refer-anchor-3"></div>

<div id="refer-anchor-3"></div>

- [3] LI J, KLEE BARILLAS J, GUENTHER C, et al. A comparative study of state of charge estimation algorithms for LiFePO4 batteries used in electric vehicles [J]. Journal of Power Sources, 2013, 230: 244-50. https://doi.org/10.1016/j.jpowsour.2012.12.057

<div id="refer-anchor-4"></div>

- [4] WAAG W, FLEISCHER C, SAUER D U. Adaptive on-line prediction of the available power of lithium-ion batteries [J]. Journal of Power Sources, 2013, 242: 548-59. https://doi.org/10.1016/j.jpowsour.2013.05.111

  <div id="refer-anchor-5"></div>

- [5] WAAG W, FLEISCHER C, SAUER D U. Adaptive on-line prediction of the available power of lithium-ion batteries [J]. Journal of Power Sources, 2013, 242: 548-59. https://doi.org/10.1016/j.jpowsour.2013.05.111

<div id="refer-anchor-6"></div>
